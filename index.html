<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f3d2e">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ALVIS V√§xtkoll</title>

  <!-- PDF (valfritt men aktiverar "Skapa PDF") -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --danger:#ef4444;
      --soft:#eef2ff;
      --line:#e5e7eb;
      --pill:#f1f5f9;
      --ok:#10b981;
      --warn:#f59e0b;
      --due:#ef4444;
      --shadow: 0 8px 24px rgba(15,23,42,.08);
      --radius: 18px;
      --radius2: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--font);
    }
    .app{
      max-width: 740px;
      margin: 0 auto;
      padding: 14px 14px 86px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 6px 4px 10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      font-size: 22px;
    }
    .brand .leaf{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background:var(--soft);
      border:1px solid #dbeafe;
      box-shadow: 0 6px 18px rgba(37,99,235,.12);
    }
    .brand small{display:block;color:var(--muted);font-weight:600;font-size:12px;margin-top:2px}
    .sunBtn{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow: var(--shadow);
      cursor:pointer;
      display:grid;place-items:center;
      user-select:none;
    }
    .sunBtn:active{transform:scale(.98)}
    .sun{font-size:20px}

    /* Tabs */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 6px 2px 12px;
    }
    .tab{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 8px 20px rgba(15,23,42,.06);
      user-select:none;
    }
    .tab:focus{outline:none;}
    .tab:focus-visible{outline:2px solid rgba(99,102,241,.35); outline-offset:2px;}
    .tab.active{
      background: var(--soft);
      border-color:#c7d2fe;
      color:#1e3a8a;
    }

    /* Sections */
    .section{
      display:none;
      padding-top: 12px;
      animation: fade .14s ease-out;
    }
    .section.active{display:block}
    @keyframes fade{from{opacity:.35; transform: translateY(4px)}to{opacity:1; transform: translateY(0)}}

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
    }
    .card h2{
      margin: 0 0 10px;
      font-size: 18px;
    }
    .subtle{color:var(--muted);font-weight:600;font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 200px}

    label{
      display:block;
      font-weight:800;
      font-size: 13px;
      margin-bottom: 7px;
    }
    .input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background:#f8fafc;
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
    }
    textarea{min-height:84px; resize: vertical}
    .input:focus, select:focus, textarea:focus{
      border-color:#93c5fd;
      box-shadow: 0 0 0 4px rgba(147,197,253,.25);
      background:#fff;
    }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      padding: 11px 14px;
      border-radius: 14px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .btn.neutral{
      background:#f8fafc;
      border-color: var(--line);
      color: var(--text);
    }
    body.dark .btn.neutral{background:#0b1326;}
    .btn.neutral:hover{filter:brightness(.99)}
    .btn.success{
      background: var(--ok);
      border-color: var(--ok);
      color: white;
    }
    .btn.success:hover{filter:brightness(.95)}
    .btn.primary{
      background:var(--primary);
      border-color: var(--primary);
      color:white;
    }
    .btn.primary:hover{background:var(--primary-2)}
    .btn.danger{
      background: var(--danger);
      border-color: var(--danger);
      color:white;
    }
    .btn.ghost{
      background:#f8fafc;
    }
    .btn:active{transform:scale(.99)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: var(--pill);
      border:1px solid var(--line);
      font-weight:800;
      font-size: 12px;
      color: #0f172a;
      user-select:none;
    }
    .pill.due{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.35)}
    .pill.soon{background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.35)}
    .pill.ok{background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.35)}
    .pill .drop{font-size:14px}

    /* Plant item */
    .plant{
      display:flex;
      gap:12px;
      border:1px solid var(--line);
      background:#fff;
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
      margin-bottom: 10px;
      align-items:center;
    }
    button.thumb{
      appearance:none;
      -webkit-appearance:none;
      background:#f1f5f9;
      border:1px solid var(--line);
    }
    body.dark button.thumb{background:#0b1326;}
    .thumb{
      width:76px;height:76px;border-radius: 16px;
      border:1px solid var(--line);
      overflow:hidden;
      background:#f1f5f9;
      display:grid;place-items:center;
      flex:0 0 auto;
      position:relative;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .noimg{color:var(--muted);font-weight:800;font-size:12px}
    .plantMain{flex:1 1 auto; min-width: 0}
    .plantTop{
      display:flex;
      gap:8px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .plantName{
      font-weight:900;
      font-size: 16px;
      line-height:1.2;
      margin:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 100%;
    }
    .metaLine{
      display:flex;gap:10px;flex-wrap:wrap; align-items:center;
      margin-top:6px;
      color: var(--muted);
      font-weight:700;
      font-size: 13px;
    }
    .plantActions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .starBtn{
      width:40px;height:40px;border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      display:grid;place-items:center;
      user-select:none;
    }
    .starBtn.on{
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.35);
    }

    details.more{
      margin-top:10px;
      border-top:1px dashed var(--line);
      padding-top:10px;
    }
    details.more summary{
      cursor:pointer;
      font-weight:900;
      color:#111827;
      list-style:none;
    }
    details.more summary::-webkit-details-marker{display:none}
    .timelineWrap{
      margin-top:12px;
      padding-top:12px;
      border-top:1px dashed var(--line);
    }
    .timelineHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .timelineStrip{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
    }
    .timelineItem{
      flex:0 0 auto;
      width:118px;
      scroll-snap-align:start;
    }
    .timelineThumb{
      width:118px;height:86px;
      border-radius:14px;
      border:1px solid var(--line);
      overflow:hidden;
      background:#f1f5f9;
      display:grid;place-items:center;
      cursor:pointer;
    }
    body.dark .timelineThumb{background:#0b1326;}
    .timelineThumb img{width:100%;height:100%;object-fit:cover;display:block}
    .timelineCap{
      margin-top:6px;
      font-weight:800;
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
      max-height: 2.4em;
      overflow:hidden;
    }

    .kvs{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }
    .kv{
      display:flex;
      gap:10px;
      justify-content:space-between;
      padding: 10px 12px;
      border-radius: 14px;
      background:#f8fafc;
      border:1px solid var(--line);
      font-weight:800;
      color:#0f172a;
    }
    .kv span{color:var(--muted);font-weight:800}
    .hint{
      font-size: 13px;
      font-weight:700;
      color: var(--muted);
      margin-top: 6px;
    }

    /* Filters */
    .filterBar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;
    }
    .filterBar .input, .filterBar select{background:#fff}

    /* Footer hint */
    .footHint{
      text-align:center;
      color:var(--muted);
      font-weight:700;
      font-size: 12px;
      margin-top: 14px;
    }

    /* Dark mode */
    body.dark{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2a44;
      --pill:#111c33;
      --soft:#0b1a3a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    body.dark .input, body.dark select, body.dark textarea{background:#0b1326;color:var(--text)}
    body.dark .plant, body.dark .starBtn, body.dark .tab, body.dark .sunBtn{background:#0f172a}
    body.dark button.thumb{
      appearance:none;
      -webkit-appearance:none;
      background:#f1f5f9;
      border:1px solid var(--line);
    }
    body.dark button.thumb{background:#0b1326;}
    .thumb{background:#0b1326}
    body.dark .kv{background:#0b1326}
  
    /* --- v17: kompakt L√§gg till --- */
    .verBadge{font-size:12px;font-weight:900;color:var(--muted);margin-top:-6px;margin-bottom:10px}
    details.compactDetails{border:1px dashed var(--line);border-radius:var(--radius2);padding:10px 12px;background:rgba(0,0,0,.01)}
    body.dark details.compactDetails{background:rgba(255,255,255,.03)}
    details.compactDetails summary{cursor:pointer;font-weight:900;list-style:none}
    details.compactDetails summary::-webkit-details-marker{display:none}
    .photoRow{display:flex;gap:12px;align-items:flex-start;flex-wrap:nowrap}
    .photoRow .thumb{flex:0 0 auto}
    .photoRow .photoControls{flex:1 1 auto}
    @media (max-width: 420px){
      .row{gap:10px}
      .photoRow{gap:10px}
    }


.btn.small{padding:10px 12px;border-radius:14px;font-weight:800;}
.collapsible{ padding:0; overflow:hidden; }
.collapsibleSummary{
  list-style:none;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px 14px;
  cursor:pointer;
  user-select:none;
}

      .collapsibleRight{display:flex; align-items:center; gap:10px;}
      .chev{font-size:22px; line-height:1; opacity:.7; transform:rotate(0deg); transition:transform .18s ease;}
      details[open] .chev{transform:rotate(90deg);}
.collapsibleSummary::-webkit-details-marker{ display:none; }
.collapsibleTitle{ display:flex; align-items:center; gap:10px; font-weight:800; color:var(--text); }
.collapsibleBody{ padding:0 14px 14px; }
details.collapsible[open] .collapsibleSummary{ border-bottom:1px dashed rgba(0,0,0,.08); }




/* Enhetlig h√∂jd under flikarna */
.section{ padding-top: 12px; }
#sec-add .card:first-child{ margin-top: 0 !important; }


/* Mer-fliken: PDF-rutan ska ligga direkt under flikarna */
#sec-more { padding-top: 12px !important; }
#sec-more > .card:first-child { margin-top: 0 !important; }


/* Enhetligare kort: √§ven "dashed"/transparenta rutor ska f√• lite vitt */
.card[style*="background:#fff0"]{
  background: rgba(255,255,255,.72) !important;
}
/* "Mer"-details och liknande ska inte se gr√•a ut */
.compactDetails{
  background: rgba(255,255,255,.65) !important;
}


/* Flera foton per v√§xt: vertikal "strip" bredvid huvudbild */
.thumbWrap{display:flex; gap:8px; align-items:stretch;}
.thumbMain{width:84px; height:84px; border-radius:16px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:var(--soft); flex:0 0 auto;}
.thumbMain img{width:100%; height:100%; object-fit:cover; display:block;}
.thumbStrip{display:flex; flex-direction:column; gap:6px; justify-content:space-between;}
.thumbMini{width:26px; height:26px; border-radius:9px; border:1px solid var(--line); background:rgba(255,255,255,.7); overflow:hidden; padding:0; cursor:pointer;}
.thumbMini img{width:100%; height:100%; object-fit:cover; display:block;}
.thumbMini.active{outline:2px solid rgba(37,99,235,.55);}



/* ===== F√∂rb√§ttrad nattl√§ge-text ===== */
body.dark,
body.dark .card,
body.dark .section,
body.dark .btn,
body.dark .input,
body.dark select,
body.dark option,
body.dark label,
body.dark h1,
body.dark h2,
body.dark h3,
body.dark p,
body.dark span {
  color: #ffffff !important;
}

body.dark .btn.ghost {
  color: #ffffff !important;
  border-color: rgba(255,255,255,0.3) !important;
}

body.dark .subtle {
  color: rgba(255,255,255,0.8) !important;
}

body.dark input::placeholder {
  color: rgba(255,255,255,0.6) !important;
}


/* ===== F√∂rb√§ttrad bildmodal storlek ===== */
.modal-content {
  max-height: 90vh !important;
  display: flex;
  flex-direction: column;
}

.modal-content img {
  max-height: 65vh !important;  /* cirka 30% mindre √§n fullh√∂jd */
  object-fit: contain !important;
}

.modal-body {
  overflow: hidden !important;
}


/* ===== Bildmodal: garanterat utan scroll ===== */
#photoModal{
  max-height: 85vh !important;
}
#photoModal::backdrop{
  background: rgba(0,0,0,.55);
}
#photoModal > div{
  max-height: 85vh !important;
  display:flex !important;
  flex-direction:column !important;
}
/* inner card */
#photoModal > div > div{
  max-height: 85vh !important;
  display:flex !important;
  flex-direction:column !important;
}
/* content area (padding:12px wrapper √§r div nr 2) */
#photoModal > div > div > div:nth-child(2){
  display:flex !important;
  flex-direction:column !important;
  gap:10px !important;
  overflow:hidden !important;
}
#photoModalImg{
  max-height: 55vh !important; /* ~30% mindre √§n tidigare */
  width:100% !important;
  height:auto !important;
  object-fit:contain !important;
}
#photoModalMeta{
  margin-top: 0 !important;
}


        
        .photoModalFooter{
          display:flex;
          justify-content:center;
          align-items:center;
          gap:16px;
          flex-wrap:wrap;
        }
        
body.dark .secondary,
body.dark .btn-secondary,
body.dark .ghost {
  background: #1e293b !important;   /* m√∂rk bakgrund */
  color: #ffffff !important;        /* vit text */
  border: 1px solid #334155 !important;
}

body.dark .secondary:disabled,
body.dark .btn-secondary:disabled {
  background: #0f172a !important;
  color: #94a3b8 !important;
  opacity: 1 !important;
}


.appInfoFooter{
  margin: 40px 0 10px 0;
  padding: 0 12px;
  font-size: 12px;
  line-height: 1.5;
  opacity: 0.8;
}

body.dark .appInfoFooter{
  color: #ffffff;
  opacity: 0.7;
}

</style>
        
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="leaf">üåø</div>
        <div>
          ALVIS V√§xtkoll
</div>
      </div>
      <button class="sunBtn" id="toggleTheme" title="V√§xla tema"><span class="sun">‚òÄÔ∏è</span></button>
    </div>

    <div class="tabs" role="tablist" aria-label="ALVIS V√§xtkoll flikar">
      <button class="tab active" data-tab="plants">V√§xter</button>
      <button class="tab" data-tab="add">L√§gg till</button>
      <button class="tab" data-tab="more">Mer</button>
    </div>

    <!-- FAVORITER -->
    
    <!-- V√ÑXTER -->
    <section class="section active" id="sec-plants">
<div id="plantsTodayWrap">
      <!-- Filter (Hem/Rum) f√∂r dagens vy -->
      <div class="card" style="margin-bottom:14px">
        <div class="row" style="align-items:flex-start; gap:14px">
          <div style="flex:1 1 260px">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px">
              <div class="drop" style="font-size:20px">üíß</div>
              <div>
                <div style="font-weight:900; font-size:20px; line-height:1.1">Idag</div>
</div>
            </div>
            <div class="grid2">
              <div>
                <label for="todayHome">Hem</label>
                <select id="todayHome"></select>
              </div>
              <div>
                <label for="todayRoom">Rum</label>
                <select id="todayRoom"></select>
              </div>
            </div>
          </div></div>
      </div>
      <details class="card collapsible" id="todayWateredCard">
        <summary class="collapsibleSummary">
          <div class="collapsibleTitle"><span class="subtle" style="font-weight:900">Vattnad idag</span></div>
          <span class="collapsibleRight">
            <div class="pill ok"><span>‚úÖ</span> <span id="todayWateredCount">0</span></div>
            <span class="chev">‚Ä∫</span>
          </span>
        </summary>
        <div class="collapsibleBody">
          <div id="todayWatered"></div>
        </div>
      </details>
      <details class="card collapsible" id="todayNeedCard">
        <summary class="collapsibleSummary">
          <div class="collapsibleTitle"><span class="subtle" style="font-weight:900">Ska vattnas idag</span></div>
          <span class="collapsibleRight">
            <div class="pill due"><span class="drop">üíß</span> <span id="todayNeedCount">0</span></div>
            <span class="chev">‚Ä∫</span>
          </span>
        </summary>
        <div class="collapsibleBody">
          <div id="todayNeed"></div>
        </div>
      </details>
      <details class="card collapsible" id="todaySoonCard">
        <summary class="collapsibleSummary">
          <div class="collapsibleTitle"><span class="subtle" style="font-weight:900">Ska vattnas inom 1‚Äì3 dagar</span></div>
          <span class="collapsibleRight">
            <div class="pill soon"><span>‚è≥</span> <span id="todaySoonCount">0</span></div>
            <span class="chev">‚Ä∫</span>
          </span>
        </summary>
        <div class="collapsibleBody">
          <div id="todaySoon"></div>
        </div>
      </details>
      <details class="card collapsible" id="todayLaterCard">
        <summary class="collapsibleSummary">
          <div class="collapsibleTitle"><span class="subtle" style="font-weight:900">Ska vattnas senare</span></div>
          <span class="collapsibleRight">
            <div class="pill ok"><span>‚úÖ</span> <span id="todayLaterCount">0</span></div>
            <span class="chev">‚Ä∫</span>
          </span>
        </summary>
        <div class="collapsibleBody">
          <div id="todayLater"></div>
        </div>
      </details>
    
      </div>
<!-- Arkiv flyttat hit (l√§ngst ner) -->
      <div class="card">
        <h2 style="margin-top:0">Arkiv (vissnade v√§xter)</h2>
        <div class="subtle">Arkivera en v√§xt n√§r den vissnat. Den tas bort fr√•n listorna men finns kvar h√§r som ‚Äúv√§xthistoria‚Äù.</div>
        <div class="btnRow">
          <button class="btn" id="showArchive">Visa arkiv</button>
        </div>
        <div id="archiveList" style="margin-top:12px; display:none"></div>
      </div>
    </section>

    <section class="section" id="sec-fav">
      <div class="card">
        <h2>Favoriter</h2>
        <div class="pill"><span class="drop">üíß</span> Beh√∂ver idag: <span id="favNeedCount">0</span></div>
        <div style="height:10px"></div>
        <div class="pill"><span>‚è≥</span> Snart: <span id="favSoonCount">0</span></div>
        <div class="hint">Din lugna startsida. Tryck ‚≠ê p√• en v√§xt f√∂r att l√§gga till h√§r.</div>
      </div>

      <div class="card">
        <div class="plantActions" style="margin-top:0; justify-content:space-between">
          <div style="font-weight:900">Favoriter & senast √∂ppnade</div>
          <button class="btn ghost" id="favShowAll">Visa alla</button>
        </div>
        <div id="favList" style="margin-top:12px"></div>
      </div>
    </section>

    

    

    <!-- L√ÑGG TILL -->
    <section class="section" id="sec-add">
      <div class="card" style="box-shadow:none;border-radius: var(--radius2); background:#fff0; border:1px dashed var(--line)">
          <h2 style="margin-top:0;font-size:16px">‚¨áÔ∏è Importera v√§xt</h2>
          <div class="subtle">L√§gg till en v√§xt fr√•n en exportfil (JSON).</div>
          <div class="btnRow">
            <input class="input" id="importPlantFile" type="file" accept="application/json" />
          </div>
        </div>

      <div class="card">
        <h2>‚ûï L√§gg till v√§xt</h2>
<div class="row">
          <div>
            <label for="pName">V√§xtnamn / smeknamn</label>
            <input class="input" id="pName" placeholder="t.ex. Stor fredskalla" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="pHome">Hem</label>
            <select id="pHome"></select>
          </div>
          <div>
            <label for="pRoom">Rum</label>
            <select id="pRoom"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="pInterval">Vattna var (dagar)</label>
            <input class="input" id="pInterval" type="number" min="1" step="1" value="7" />
          </div>
          <div>
            <label for="pLast">Senast vattnad</label>
            <input class="input" id="pLast" type="date" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Foto</label>
            <div class="photoRow">
              <div class="thumb" style="width:86px;height:86px" id="pPhotoPreview"><div class="noimg">Inget foto</div></div>
              <div class="photoControls">
                <div class="row" style="align-items:center;margin-top:0">
                  <input class="input" id="pPhoto" type="file" accept="image/*" multiple />
                  <button class="btn danger small" id="pPhotoClear" type="button">Ta bort</button>
                </div>
</div>
            </div>
          </div>
        </div>

        <details class="compactDetails" style="margin-top:12px">
          <summary>‚ú® Mer</summary>

          <div style="height:10px"></div>

          <div class="row">
            <div>
              <label for="pPlace">Plats (fri text)</label>
              <input class="input" id="pPlace" placeholder="t.ex. f√∂nsterbr√§dan, hyllan ovan" />
            </div>
            <div>
              <label for="pWindow">F√∂nster / l√§ge</label>
              <select id="pWindow">
                <option value="">V√§lj‚Ä¶</option>
                <option>Norrl√§ge</option>
                <option>S√∂derl√§ge</option>
                <option>√ñsterl√§ge</option>
                <option>V√§sterl√§ge</option>
                <option>Mitt i rummet</option>
                <option>Skugga</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="pPrice">Ink√∂pspris (kr)</label>
              <input class="input" id="pPrice" type="number" min="0" step="1" placeholder="t.ex. 199" />
            </div>
            <div>
              <label for="pStore">K√∂pt p√• (butik)</label>
              <input class="input" id="pStore" placeholder="t.ex. Blomsterlandet" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="pBuy">K√∂pt datum</label>
              <input class="input" id="pBuy" type="date" />
            </div>
            <div></div>
          </div>

          <div class="row">
            <div>
              <label for="pNotes">Notering / instruktion</label>
              <textarea id="pNotes" placeholder="t.ex. Vattna ordentligt‚Ä¶ ‚Ä¢ vill st√• ljust ‚Ä¢ torkar l√§tt"></textarea>
            </div>
          </div>
        </details>

        <div class="btnRow">
          <button class="btn primary" id="savePlant">Spara v√§xt</button>
          <button class="btn ghost" id="fillExample">Fyll med exempel</button>
        </div>
</div>
        </div>

      
      </div>
    </section>

    <!-- MER -->
    <section class="section" id="sec-more">
  <div class="card" style="box-shadow:none;margin:0;border-radius: var(--radius2); background:#fff0; border:1px dashed var(--line)">
    <h2 style="margin-top:0;font-size:16px">üìÑ PDF (f√∂r valt hem)</h2>
    <div class="subtle">Bra n√§r n√•gon annan ska vattna. Sorteras per rum.</div>
    <div style="height:10px"></div>

    <div class="btnRow">
      <label style="margin:0;font-weight:900">Hem</label>
      <select class="input" id="pdfHome" style="max-width:240px"></select>
      <div style="flex:1 1 160px"></div>
      <button class="btn" id="makePdf">Ladda ner PDF</button>
    </div>

    <div style="height:12px"></div>

    <h2 style="margin-top:0;font-size:16px">Delning</h2>
    <div class="btnRow">
      <button class="btn" id="exportHome">Exportera hem</button>
      <div style="flex:1 1 260px"></div>
      <label style="margin:0;font-weight:900">Importera hem</label>
      <input class="input" id="importHomeFile" type="file" accept="application/json" />
    </div>

    <div style="height:8px"></div>

    <div class="btnRow">
      <button class="btn" id="exportAll">Exportera alla v√§xter</button>
    </div>

    <div style="height:10px"></div>

    <div style="height:12px"></div>
  </div>
</section>
  </div>

  <!-- Global bildv√§ljare f√∂r att byta foto genom att trycka p√• profilbilden -->
  <input id="globalPhotoPicker" type="file" accept="image/*" capture="environment" style="display:none" / multiple>
  <input id="timelinePhotoPicker" type="file" accept="image/*" capture="environment" style="display:none" />

  <dialog id="photoModal" style="border:none;border-radius:18px;max-width:min(92vw,560px);width:92vw;box-shadow:0 18px 60px rgba(0,0,0,.35);padding:0;">
    <div style="background:var(--card);border:1px solid var(--line);border-radius:18px;overflow:hidden;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);">
        <div style="font-weight:900" id="photoModalTitle">Foto</div>
        
      </div>
      <div style="padding:12px;">
        <img id="photoModalImg" alt="" style="width:100%;height:auto;border-radius:14px;border:1px solid var(--line);background:#0000;"/>
        <div class="hint" id="photoModalMeta" style="margin-top:10px;"></div>
        <div class="btnRow" style="justify-content:space-between;">
          <button class="btn ghost" id="photoModalPrev">‚óÄ</button>
          <button class="btn ghost" id="photoModalNext">‚ñ∂</button>
          
<button class="btn" id="photoModalChange" type="button" style="margin-left:auto">√Ñndra bild</button>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    // ========== Data ==========
    const STORE_KEY = "alvi_vaxt_v1";

    const todayISO = () => new Date().toISOString().slice(0,10);
    const parseISO = (s) => s ? new Date(s + "T00:00:00") : null;
    const fmtISO = (s) => s || "‚Äî";
    const addDays = (iso, days) => {
      if(!iso) return null;
      const d = parseISO(iso);
      d.setDate(d.getDate() + Number(days || 0));
      return d.toISOString().slice(0,10);
    };
    const daysBetween = (aISO, bISO) => {
      const a = parseISO(aISO), b = parseISO(bISO);
      if(!a || !b) return null;
      const ms = b - a;
      return Math.floor(ms / (1000*60*60*24));
    };

    
    function ensurePhotos(p){
      if(!p) return p;
      if(!Array.isArray(p.photos)){
        p.photos = p.photo ? [p.photo] : [];
      }
      // h√•ll photo synkad med f√∂rsta bilden
      p.photo = p.photos[0] || null;
      return p;
    }
function uid(){
      return Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);
    }

    function defaultState(){
      return {
        settings: { dark:false },
        homes: [
          { id:"home-1", name:"Hemma", rooms:["Vardagsrum","Sovrum","K√∂k","Badrum","Balkong","Annan"] }
        ],
        plants: [
          // Exempel (kan raderas)
          {
            id: uid(),
            name:"Stor fredskalla",
            homeId:"home-1",
            room:"Vardagsrum",
            place:"",
            window:"",
            intervalDays:7,
            lastWatered:null,
            price:null,
            store:"",
            buyDate:"",
            notes:"",
            favorite:true,
            archived:false,
            photo:null,
            openedAt: Date.now(),
            gallery: []
          },
          {
            id: uid(),
            name:"Monstera",
            homeId:"home-1",
            room:"Vardagsrum",
            place:"",
            window:"",
            intervalDays:10,
            lastWatered:null,
            price:null,
            store:"",
            buyDate:"",
            notes:"",
            favorite:false,
            archived:false,
            photo:null,
            openedAt: Date.now(),
            gallery: []
          },
          {
            id: uid(),
            name:"Fredskalla",
            homeId:"home-1",
            room:"Vardagsrum",
            place:"F√∂nsterbr√§dan",
            window:"√ñsterl√§ge",
            intervalDays:7,
            lastWatered: addDays(todayISO(), -6),
            price:199,
            store:"Blomsterlandet",
            buyDate: addDays(todayISO(), -12),
            notes:"Vattna ordentligt tills det rinner igenom. H√§ll bort √∂verfl√∂d i ytterkrukan efter 10 min. Spreja/mista bladen l√§tt. Vattna inte i bladroszetten. Vattna i toaletten, blir annars fl√§ckigt och √§ckligt p√• br√§dan!",
            favorite:false,
            archived:false,
            photo:null,
            openedAt: Date.now(),
            gallery: []
          }
        ]
      };
    }

    
    // ========== Best√§ndig lagring (IndexedDB + localStorage) ==========
    const IDB_NAME = "alvi_vaxt_db";
    const IDB_STORE = "kv";
    const IDB_KEY = "state";

    function idbOpen(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbGetState(){
      try{
        const db = await idbOpen();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, "readonly");
          const st = tx.objectStore(IDB_STORE).get(IDB_KEY);
          st.onsuccess = () => resolve(st.result || null);
          st.onerror = () => reject(st.error);
        });
      }catch(e){
        return null;
      }
    }

    async function idbSetState(val){
      try{
        const db = await idbOpen();
        await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, "readwrite");
          const req = tx.objectStore(IDB_STORE).put(val, IDB_KEY);
          req.onsuccess = () => resolve(true);
          req.onerror = () => reject(req.error);
        });
      }catch(e){
        // ignore
      }
    }

function loadState(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) {
          const d = defaultState();
          d.meta ||= {};
          d.meta.updatedAt ||= 0;
          return d;
        }
        const st = JSON.parse(raw);
        st.meta ||= {};
        st.meta.updatedAt ||= 0;
        // mild migration defaults
        st.settings ||= { dark:false };
        if(!Array.isArray(st.homes) || st.homes.length===0) st.homes = defaultState().homes;
        // s√§kerst√§ll att varje hem har minst ett rum
        st.homes.forEach(h => { if(!Array.isArray(h.rooms) || h.rooms.length===0) h.rooms = ["Annan", "Utomhus"]; });
        st.plants ||= [];
        // ensure plants have valid homeId
        const validHomeIds = new Set(st.homes.map(h=>h.id));
        st.plants.forEach(p => { if(!p.homeId || !validHomeIds.has(p.homeId)) p.homeId = st.homes[0]?.id; });
        // migration: galleri/tidslinje
        st.plants.forEach(p => { if(!Array.isArray(p.gallery)) p.gallery = []; });
        return st;
      }catch(e){
        return defaultState();
      }
    }
    function saveState(){
      state.meta ||= {};
      state.meta.updatedAt = Date.now();
      try{
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
      }catch(e){
        // Om storagekvot spr√§ngs: spara en bantad version s√• v√§xterna inte f√∂rsvinner.
        try{
          const slim = JSON.parse(JSON.stringify(state));
          // minnen kan v√§xa ‚Äì rensa deras foton f√∂rst (om finns)
          for(const p of (slim.plants||[])){
            if(Array.isArray(p.memories)){
              for(const m of p.memories){
                if(m && m.photo) m.photo = null;
                if(m && Array.isArray(m.photos)) m.photos = [];
              }
            }
          }
          localStorage.setItem(STORE_KEY, JSON.stringify(slim));
          state = slim;
        }catch(e2){
          (typeof dbg==="function"?dbg:console.error)("Kunde inte spara i localStorage (m√∂jligen p.g.a. content:// eller webview-begr√§nsning).", e2);
        }
      }
      // Skriv √§ven till IndexedDB (mer stabilt p√• Android/WebView och st√∂rre kvot)
      try{ idbSetState(state); }catch(e){}
    }

    let state = loadState();

    // Efter start: f√∂rs√∂k l√§sa fr√•n IndexedDB (om localStorage inte sparar korrekt)
    idbGetState().then((st) => {
      if(!st) return;
      try{
        st.meta ||= {};
        st.meta.updatedAt ||= 0;
        // Om IDB √§r nyare (eller LS verkar tomt/default), anv√§nd IDB-state
        const shouldUse = (!state?.plants?.length && (st.plants||[]).length) || (st.meta.updatedAt > (state?.meta?.updatedAt||0));
        if(shouldUse){
          state = st;
          // K√∂r samma milda migration som loadState
          state.settings ||= { dark:false };
          if(!Array.isArray(state.homes) || state.homes.length===0) state.homes = defaultState().homes;
          state.homes.forEach(h => {
          if(Array.isArray(h.rooms) && !h.rooms.includes("Utomhus")){
            h.rooms.push("Utomhus");
          } if(!Array.isArray(h.rooms) || h.rooms.length===0) h.rooms = ["Annan", "Utomhus"]; });
          state.plants ||= [];
          const validHomeIds = new Set(state.homes.map(h=>h.id));
          state.plants.forEach(p => { if(!p.homeId || !validHomeIds.has(p.homeId)) p.homeId = state.homes[0]?.id; });
          state.plants.forEach(p => { if(!Array.isArray(p.gallery)) p.gallery = []; });
          // h√•lla photo/photos synk (om helper finns)
          try{ state.plants = (state.plants||[]).map(ensurePhotos); }catch(e){}
          // Rendera om
          try{ applyTheme?.(); }catch(e){}
          try{ renderToday(); renderAll(); renderMore(); }catch(e){}
        }
      }catch(e){}
    });


    // Vid appstart: h√•ll alla listor st√§ngda oavsett tidigare val
    state.todayOpenTouched = false;
    state.todayOpen = null;


    // ========== Fels√∂kning ==========
    const debugLogEl = document.getElementById("debugLog");
    const debugStatusEl = document.getElementById("debugStatus");
    function dbg(msg, err){
      try{
        const t = new Date().toISOString();
        const line = `[${t}] ${msg}` + (err ? `\n  ${err && err.stack ? err.stack : err}` : "");
        if(debugLogEl){
          debugLogEl.textContent = (debugLogEl.textContent ? (debugLogEl.textContent + "\n\n") : "") + line;
        }
        if(debugStatusEl){
          debugStatusEl.textContent = "Fel loggat";
        }
        console.error(msg, err);
      }catch(_){}
    }
    window.addEventListener("error", (ev)=>{ dbg("JavaScript-fel", ev.error || ev.message); });
    window.addEventListener("unhandledrejection", (ev)=>{ dbg("Ohanterad promise-rejection", ev.reason); });

    function emptyHint(text){
      const d = document.createElement("div");
      d.className = "empty-hint";
      d.textContent = text || "";
      // mild inline fallback styling (if CSS saknas)
      d.style.padding = "10px 12px";
      d.style.opacity = "0.8";
      d.style.fontSize = "0.95rem";
      return d;
    }


    const debugCopyBtn = document.getElementById("debugCopy");
    const debugClearBtn = document.getElementById("debugClear");
    if(debugCopyBtn){
      debugCopyBtn.addEventListener("click", async ()=>{
        try{
          const txt = debugLogEl ? debugLogEl.textContent : "";
          await navigator.clipboard.writeText(txt || "");
          if(debugStatusEl) debugStatusEl.textContent = "Kopierat!";
        }catch(e){
          dbg("Kunde inte kopiera till urklipp.", e);
        }
      });
    }
    if(debugClearBtn){
      debugClearBtn.addEventListener("click", ()=>{
        if(debugLogEl) debugLogEl.textContent = "";
        if(debugStatusEl) debugStatusEl.textContent = "Rensad";
      });
    }


    // ========== Theme ==========
    const toggleThemeBtn = document.getElementById("toggleTheme");
    function applyTheme(){
      document.body.classList.toggle("dark", !!state.settings.dark);
      toggleThemeBtn.querySelector(".sun").textContent = state.settings.dark ? "üåô" : "‚òÄÔ∏è";
    }
    toggleThemeBtn.addEventListener("click", () => {
      state.settings.dark = !state.settings.dark;
      saveState();
      applyTheme();
    });
    applyTheme();

    // ========== Tabs ==========
    const tabs = Array.from(document.querySelectorAll(".tab"));
    const sections = {
      plants: document.getElementById("sec-plants"),
      add: document.getElementById("sec-add"),
      more: document.getElementById("sec-more"),
      // (dolda/legacy)
      fav: document.getElementById("sec-fav"),
    };

    function setTab(key){
      // Markera aktiv flik tydligt (och avmarkera alla andra)
      tabs.forEach(t => t.classList.remove("active"));
      const activeTab = tabs.find(t => t.dataset.tab === key);
      if(activeTab){
        activeTab.classList.add("active");
        // ta bort fokus s√• att mobilen inte "h√•ller kvar" visuellt l√§ge
        activeTab.blur?.();
      }

      Object.entries(sections).forEach(([k,el]) => { if(el) el.classList.toggle("active", k===key); });

      if(key==="plants") renderPlants();
      if(key==="add") { refreshAddFormSelects(); }
      if(key==="more") renderMore();

      // Robust scroll-to-top when switching tabs (Android WebView can keep old scroll position)
      try{ document.activeElement?.blur?.(); }catch(e){}
      const prevSB = document.documentElement.style.scrollBehavior;
      document.documentElement.style.scrollBehavior = "auto";
      const goTop = () => {
        try{ window.scrollTo(0,0); }catch(e){}
        try{ document.documentElement.scrollTop = 0; }catch(e){}
        try{ document.body.scrollTop = 0; }catch(e){}
      };
      // K√∂r flera g√•nger och efter rendering
      goTop();
      requestAnimationFrame(() => { goTop(); requestAnimationFrame(goTop); });
      setTimeout(goTop, 80);
      setTimeout(goTop, 180);
      setTimeout(() => { goTop(); document.documentElement.style.scrollBehavior = prevSB; }, 320);
}

    tabs.forEach(t => t.addEventListener("click", (e) => {
      e.preventDefault();
      setTab(t.dataset.tab);
    }));

    
    // ========== V√§xter ==========
    const plantsAllDetails = document.getElementById("plantsAllDetails");

    if(plantsAllDetails){
      plantsAllDetails.addEventListener("toggle", () => {
        if(plantsAllDetails.open){
          renderAll();
        }
      });
    }

    function renderPlants(){
      renderToday();
      if(plantsAllDetails?.open) renderAll();
      const arch = document.getElementById("archiveList");
      if(arch && arch.style.display !== "none") renderArchive(true);
    }

// ========== Helpers ==========
    function getHome(homeId){
      return state.homes.find(h => h.id === homeId) || state.homes[0];
    }

    function plantNext(plant){
      if(!plant.lastWatered) return null;
      return addDays(plant.lastWatered, plant.intervalDays || 7);
    }

    function urgency(plant){
      // lower is more urgent
      const next = plantNext(plant);
      if(!next) return -999; // unknown -> treat as urgent
      const d = daysBetween(todayISO(), next); // today -> next
      return d; // <=0 means due/overdue
    }

    function statusLabel(plant){
      // Extra tydligt: om den vattnades idag
      if(plant.lastWatered === todayISO()){
        // Undvik "kaka p√• kaka": visa inte "Vattnad idag" h√§r.
        // Visa ist√§llet hur m√•nga dagar kvar tills n√§sta vattning.
        const next = plantNext(plant);
        const d = next ? daysBetween(todayISO(), next) : (plant.intervalDays || 7);
        return { cls:"ok", text:`Om ${Math.max(1, d)} d`, icon:"‚úÖ", extra:`N√§sta: ${next || "‚Äî"}` };
      }

      const next = plantNext(plant);
      if(!next) return { cls:"due", text:"Beh√∂ver vatten", icon:"üíß", extra:"N√§sta: ‚Äî" };
      const d = daysBetween(todayISO(), next);
      if(d <= 0) return { cls:"due", text:"Beh√∂ver vatten", icon:"üíß", extra:`N√§sta: ${next}` };
      if(d <= 2) return { cls:"soon", text:`Snart (${d} d)`, icon:"‚è≥", extra:`N√§sta: ${next}` };
      return { cls:"ok", text:`Om ${d} d`, icon:"‚úÖ", extra:`N√§sta: ${next}` };
    }

    function byLastWatered(a,b){
      // newest first, null last
      const av = a.lastWatered ? parseISO(a.lastWatered).getTime() : -1;
      const bv = b.lastWatered ? parseISO(b.lastWatered).getTime() : -1;
      return bv - av;
    }

    function visiblePlants(){
      return state.plants.filter(p => !p.archived);
    }

    function plantMatchesSearch(p, q){
      if(!q) return true;
      q = q.toLowerCase();
      const home = getHome(p.homeId)?.name || "";
      return [
        p.name, p.room, home, p.place||"", p.window||"", p.store||"", p.notes||""
      ].join(" ").toLowerCase().includes(q);
    }

    // ========== Render: Plant card ==========
    function plantCard(plant, {showHomeRoom=true} = {}){
      const home = getHome(plant.homeId);
      const st = statusLabel(plant);

      const div = document.createElement("div");
      div.className = "plant";

      const thumb = document.createElement("div");
      thumb.className = "thumbWrap";

      const mainBtn = document.createElement("button");
      mainBtn.type = "button";
      mainBtn.className = "thumbMain";
      mainBtn.title = "Tryck f√∂r att l√§gga till/byta foto";
      mainBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        ensurePhotos(plant);
        if(plant.photos && plant.photos.length){
          openPlantPhotosModal(plant.id, plant.photoIndex||0);
        }else{
          openPhotoPickerFor(plant.id);
        }
      });

      // s√§kerst√§ll struktur
      ensurePhotos(plant);

      const setMainVisual = () => {
        mainBtn.innerHTML = "";
        if(plant.photo){
          const img = document.createElement("img");
          img.src = plant.photo;
          img.alt = plant.name;
          mainBtn.appendChild(img);
        }else{
          const no = document.createElement("div");
          no.className = "noimg";
          no.textContent = "Inget foto";
          mainBtn.appendChild(no);
        }
      };

      const strip = document.createElement("div");
      strip.className = "thumbStrip";

      const renderStrip = () => {
        strip.innerHTML = "";
        const photos = (plant.photos || []).slice(0,4);
        for(let i=0;i<4;i++){
          const b = document.createElement("button");
          b.type = "button";
          b.className = "thumbMini" + (i === (plant.photoIndex||0) ? " active" : "");
          b.title = "V√§lj bild";
          if(photos[i]){
            const im = document.createElement("img");
            im.src = photos[i];
            im.alt = "Foto " + (i+1);
            b.appendChild(im);
          }else{
            // tom plats (visas som ljus ruta)
            b.style.opacity = "0.65";
          }
          b.addEventListener("click", (e) => {
            e.stopPropagation();
            // klick p√• tom miniatyr -> √∂ppna picker f√∂r att l√§gga till fler
            if(!photos[i]){
              openPhotoPickerFor(plant.id);
              return;
            }
            plant.photoIndex = i;
            plant.photo = photos[i];
            plant.openedAt = Date.now();
            saveState();
            renderToday(); renderAll(); renderMore();
            openPlantPhotosModal(plant.id, i);
          });
          strip.appendChild(b);
        }
      };

      setMainVisual();
      renderStrip();

      thumb.appendChild(mainBtn);
      thumb.appendChild(strip);
const main = document.createElement("div");
      main.className = "plantMain";

      const top = document.createElement("div");
      top.className = "plantTop";

      const left = document.createElement("div");
      left.style.minWidth = "0";

      const name = document.createElement("p");
      name.className = "plantName";
      name.textContent = plant.name || "(Namnl√∂s v√§xt)";

      const pill = document.createElement("span");
      pill.className = `pill ${st.cls}`;
      pill.innerHTML = `<span class="drop">${st.icon}</span> ${st.text}`;

      left.appendChild(name);
      left.appendChild(pill);

      top.appendChild(left);

      const meta = document.createElement("div");
      meta.className = "metaLine";
      const nextTxt = st.extra;
      const roomTxt = plant.room ? `Rum: ${plant.room}` : "Rum: ‚Äî";
      const homeTxt = showHomeRoom ? `Hem: ${home?.name || "‚Äî"}` : "";
      meta.innerHTML = `
        <span>üìÖ ${nextTxt}</span>
        <span>üö™ ${roomTxt}</span>
        ${homeTxt ? `<span>üè† ${homeTxt}</span>` : ""}
      `;

      const actions = document.createElement("div");
      actions.className = "plantActions";

      
      const waterBtn = document.createElement("button");
      const undoBtn = document.createElement("button");
      undoBtn.className = "btn";
      undoBtn.textContent = "√Öngra vattning";
      undoBtn.style.display = "none";

      function _refreshWaterUI(){
        const watered = (plant.lastWatered === todayISO());
        if(watered){
          waterBtn.className = "btn success";
          waterBtn.textContent = "Vattnad ‚úì";
          undoBtn.style.display = "";
        }else{
          waterBtn.className = "btn primary";
          waterBtn.textContent = "Vattnad idag";
          undoBtn.style.display = "none";
        }
      }

      function _markWatered(){
        if(plant.lastWatered === todayISO()) return;
        plant._prevLastWatered = plant.lastWatered || null;
        plant.lastWatered = todayISO();
        saveState();
        renderToday(); renderAll(); renderMore();
      }

      function _undoWatered(){
        if(plant.lastWatered !== todayISO()) return;
        plant.lastWatered = plant._prevLastWatered || null;
        delete plant._prevLastWatered;
        saveState();
        renderToday(); renderAll(); renderMore();
      }

      waterBtn.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        if(plant.lastWatered === todayISO()) _undoWatered();
        else _markWatered();
      });

      undoBtn.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        _undoWatered();
      });

      _refreshWaterUI();
const details = document.createElement("details");
      details.className = "more";
      const summary = document.createElement("summary");
      summary.textContent = "‚ú® Visa mer";
      details.appendChild(summary);

      details.addEventListener("toggle", () => {
        if(details.open){
          plant.openedAt = Date.now();
          saveState();
        }
      });

      const kvs = document.createElement("div");
      kvs.className = "kvs";

      const last = plant.lastWatered || "";
      const next = plantNext(plant) || "";
      const interval = plant.intervalDays || 7;

      kvs.appendChild(kvRow("Senast", fmtISO(last)));
      kvs.appendChild(kvRow("Intervall", `var ${interval} dag` + (interval===1 ? "" : "ar")));
      kvs.appendChild(kvRow("N√§sta", fmtISO(next)));
      kvs.appendChild(kvRow("Plats", plant.place || "‚Äî"));
      kvs.appendChild(kvRow("F√∂nster/l√§ge", plant.window || "‚Äî"));
      kvs.appendChild(kvRow("Ink√∂p", `${plant.store || "‚Äî"} ‚Ä¢ Datum: ${fmtISO(plant.buyDate)} ‚Ä¢ Ink√∂pspris: ${plant.price ?? "‚Äî"} kr`));
      kvs.appendChild(kvRow("Instruktion", plant.notes || "‚Äî"));

      const btns = document.createElement("div");
      btns.className = "btnRow";

      const editBtn = document.createElement("button");
      editBtn.className = "btn";
      editBtn.textContent = "Redigera";
      editBtn.addEventListener("click", () => openEdit(plant.id));

      const archiveBtn = document.createElement("button");
      archiveBtn.className = "btn";
      archiveBtn.textContent = "Arkivera";
      archiveBtn.addEventListener("click", () => {
        if(confirm("Arkivera v√§xten? Den f√∂rsvinner fr√•n listorna men finns kvar i arkivet.")){
          plant.archived = true;
          saveState();
          renderToday(); renderAll(); renderMore();
        }
      });

      const delBtn = document.createElement("button");
      delBtn.className = "btn danger";
      delBtn.textContent = "Ta bort";
      delBtn.addEventListener("click", () => {
        if(confirm("Ta bort v√§xten permanent?")){
          state.plants = state.plants.filter(p => p.id !== plant.id);
          saveState();
          renderToday(); renderAll(); renderMore();
        }
      });

      btns.appendChild(editBtn);
      btns.appendChild(archiveBtn);
      btns.appendChild(delBtn);

      details.appendChild(kvs);

      // Tidslinje / minnen (flera foton √∂ver tid)
      const timelineWrap = document.createElement("div");
      timelineWrap.className = "timelineWrap";

      const head = document.createElement("div");
      head.className = "timelineHead";
      head.innerHTML = `<div style="font-weight:900">üì∑ Minnen</div>`;

      const addMem = document.createElement("button");
      addMem.className = "btn";
      addMem.textContent = "L√§gg till foto";
      addMem.addEventListener("click", (e) => {
        e.stopPropagation();
        openTimelinePickerFor(plant.id);
      });

      head.appendChild(addMem);
      timelineWrap.appendChild(head);

      const gallery = Array.isArray(plant.gallery) ? plant.gallery : [];

      if(gallery.length === 0){
        const h = document.createElement("div");
        h.className = "subtle";
        h.textContent = "Inga minnen √§nnu. L√§gg till ett foto n√§r n√•got h√§nder (t.ex. blomning).";
        timelineWrap.appendChild(h);
      }else{
        const strip = document.createElement("div");
        strip.className = "timelineStrip";

        gallery.slice(0, 30).forEach((g, idx) => {
          const item = document.createElement("div");
          item.className = "timelineItem";

          const t = document.createElement("div");
          t.className = "timelineThumb";
          const img = document.createElement("img");
          img.src = g.photo;
          img.alt = plant.name;
          t.appendChild(img);
          t.addEventListener("click", (e) => {
            e.stopPropagation();
            openGalleryModal(plant.id, idx);
          });

          const cap = document.createElement("div");
          cap.className = "timelineCap";
          cap.textContent = `${g.date || "‚Äî"}${g.note ? " ‚Ä¢ " + g.note : ""}`;

          item.appendChild(t);
          item.appendChild(cap);
          strip.appendChild(item);
        });

        timelineWrap.appendChild(strip);
      }

      details.appendChild(timelineWrap);
      details.appendChild(btns);

      actions.appendChild(waterBtn);
      actions.appendChild(undoBtn);
      main.appendChild(top);
      main.appendChild(meta);
      main.appendChild(actions);
      main.appendChild(details);

      div.appendChild(thumb);
      div.appendChild(main);

      // klick p√• hela kortet √∂ppnar/markerar som "senast √∂ppnad"
      div.addEventListener("click", () => {
        plant.openedAt = Date.now();
        saveState();
      });

      return div;
    }

    // Variant f√∂r PDF: samma "kort-k√§nsla" men utan knappar/interaktion
    function plantPdfCard(plant, home){
      const st = statusLabel(plant);

      const wrap = document.createElement("div");
      wrap.className = "plant";
      wrap.style.boxShadow = "none";
      wrap.style.marginBottom = "10px";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.style.border = "1px solid var(--line)";
      thumb.style.background = state.settings.dark ? "#0b1326" : "#f1f5f9";

      if(plant.photo){
        const img = document.createElement("img");
        img.src = plant.photo;
        img.alt = plant.name;
        thumb.appendChild(img);
      }else{
        const no = document.createElement("div");
        no.className = "noimg";
        no.textContent = "Inget foto";
        thumb.appendChild(no);
      }

      const main = document.createElement("div");
      main.className = "plantMain";

      const top = document.createElement("div");
      top.className = "plantTop";

      const left = document.createElement("div");
      left.style.minWidth = "0";

      const name = document.createElement("p");
      name.className = "plantName";
      name.textContent = plant.name || "(Namnl√∂s v√§xt)";

      const pill = document.createElement("span");
      pill.className = `pill ${st.cls}`;
      pill.innerHTML = `<span class="drop">${st.icon}</span> ${st.text}`;

      left.appendChild(name);
      left.appendChild(pill);
      top.appendChild(left);

      const meta = document.createElement("div");
      meta.className = "metaLine";
      meta.innerHTML = `
        <span>üìÖ ${st.extra}</span>
        <span>üö™ Rum: ${escapeHtml(plant.room || "‚Äî")}</span>
      `;

      if(plant.place){
        const place = document.createElement("div");
        place.className = "metaLine";
        place.style.marginTop = "6px";
        place.innerHTML = `<span>üìç ${escapeHtml(plant.place)}</span>${plant.window ? `<span>‚òÄÔ∏è ${escapeHtml(plant.window)}</span>` : ""}`;
        main.appendChild(place);
      }

      const notes = document.createElement("div");
      notes.style.marginTop = "8px";
      notes.style.fontWeight = "700";
      notes.style.color = "var(--muted)";
      notes.style.fontSize = "13px";
      notes.textContent = plant.notes ? `Instruktion: ${plant.notes}` : "";

      main.appendChild(top);
      main.appendChild(meta);
      if(plant.notes) main.appendChild(notes);

      wrap.appendChild(thumb);
      wrap.appendChild(main);
      return wrap;
    }

    function kvRow(k, v){
      const d = document.createElement("div");
      d.className = "kv";
      d.innerHTML = `<span>${k}</span><div style="text-align:right; max-width: 70%">${escapeHtml(String(v))}</div>`;
      return d;
    }

    function escapeHtml(str){
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ========== Dropdowns (homes/rooms) ==========
    function fillHomes(selectEl, {includeAll=false}={}){
      selectEl.innerHTML = "";
      if(includeAll){
        const opt = document.createElement("option");
        opt.value = "__all__";
        opt.textContent = "Alla";
        selectEl.appendChild(opt);
      }
      state.homes.forEach(h => {
          if(Array.isArray(h.rooms) && !h.rooms.includes("Utomhus")){
            h.rooms.push("Utomhus");
          }
        const opt = document.createElement("option");
        opt.value = h.id;
        opt.textContent = h.name;
        selectEl.appendChild(opt);
      });
    }
    function fillRooms(selectEl, homeId, {includeAll=false}={}){
      selectEl.innerHTML = "";
      if(includeAll){
        const opt = document.createElement("option");
        opt.value="__all__";
        opt.textContent="Alla";
        selectEl.appendChild(opt);
      }
      const home = getHome(homeId);

      // L√§gg alltid till minst ett rum-alternativ s√• att selecten inte blir tom
      const rooms = Array.isArray(home?.rooms) ? home.rooms.slice() : [];
      if(!rooms.includes("Annan")) rooms.push("Annan");

      rooms.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        selectEl.appendChild(opt);
      });
    }

    // ========== FAVORITES ==========
    const favNeedCount = document.getElementById("favNeedCount");
    const favSoonCount = document.getElementById("favSoonCount");
    const favList = document.getElementById("favList");
    const favShowAll = document.getElementById("favShowAll");

    favShowAll.addEventListener("click", () => setTab("all"));

    function renderFavorites(){
      const plants = visiblePlants();
      const favs = plants.filter(p => p.favorite);
      const need = favs.filter(p => {
        const next = plantNext(p);
        if(!next) return true;
        return daysBetween(todayISO(), next) <= 0;
      });
      const soon = favs.filter(p => {
        const next = plantNext(p);
        if(!next) return false;
        const d = daysBetween(todayISO(), next);
        return d > 0 && d <= 2;
      });
      favNeedCount.textContent = need.length;
      favSoonCount.textContent = soon.length;

      // Favoriter + senast √∂ppnade
      const recent = plants
        .slice()
        .sort((a,b) => (b.openedAt||0) - (a.openedAt||0))
        .slice(0, 6);

      const combined = uniqById([...favs, ...recent])
        .slice()
        .sort((a,b)=> urgency(a) - urgency(b));

      favList.innerHTML = "";
      if(combined.length === 0){
        const p = document.createElement("div");
        p.className = "subtle";
        p.textContent = "Inga favoriter √§nnu. Tryck ‚≠ê p√• en v√§xt.";
        favList.appendChild(p);
        return;
      }
      combined.forEach(p => favList.appendChild(plantCard(p)));
    }

    function uniqById(arr){
      const seen = new Set();
      const out = [];
      for(const x of arr){
        if(seen.has(x.id)) continue;
        seen.add(x.id);
        out.push(x);
      }
      return out;
    }

    // ========== TODAY ==========
    const todayHome = document.getElementById("todayHome");
    const todayRoom = document.getElementById("todayRoom");
    const todayNeed = document.getElementById("todayNeed");
    const todaySoon = document.getElementById("todaySoon");
    const todayLater = document.getElementById("todayLater");
    const todayNeedCount = document.getElementById("todayNeedCount");
    const todaySoonCount = document.getElementById("todaySoonCount");
    const todayLaterCount = document.getElementById("todayLaterCount");
    const todayWatered = document.getElementById("todayWatered");
    const todayWateredCount = document.getElementById("todayWateredCount");

    // persist filters
    let todayFilter = { homeId: state.homes[0]?.id || "home-1", room:"__all__" };

    function initTodayFilters(){
      fillHomes(todayHome);
      todayHome.value = todayFilter.homeId;
      fillRooms(todayRoom, todayFilter.homeId, {includeAll:true});
      todayRoom.value = todayFilter.room || "__all__";

      // UI-state: vilken lista som √§r √∂ppen i "V√§xter"-vyn
      if(state.todayOpen == null) state.todayOpen = null;
      if(state.todayOpenTouched == null) state.todayOpenTouched = false;


      todayHome.addEventListener("change", () => {
        state.todayOpenTouched = false;
        state.todayOpen = 'need';
        todayFilter.homeId = todayHome.value;
        fillRooms(todayRoom, todayFilter.homeId, {includeAll:true});
        todayRoom.value="__all__";
        todayFilter.room="__all__";
        renderToday();
      });
      todayRoom.addEventListener("change", () => {
        state.todayOpenTouched = false;
        state.todayOpen = 'need';
        todayFilter.room = todayRoom.value;
        renderToday();
      });
    }
    initTodayFilters();

    
    // ========== Scope (Hem/Rum) ==========
    function currentScope(){
      // Se till att selectar √§r ifyllda
      if(typeof refreshPlantsFilters === "function") refreshPlantsFilters();
      const homeId = (todayHome && todayHome.value) || (state.homes[0] && state.homes[0].id) || "";
      const room = (todayRoom && todayRoom.value) || "__all__";
      return { homeId, room };
    }
    function scopedPlants(){
      const { homeId, room } = currentScope();
      let list = visiblePlants().filter(p => !p.archived);
      if(homeId) list = list.filter(p => p.homeId === homeId);
      if(room !== "__all__") list = list.filter(p => (p.room || "Annan") === room);
      return list;
    }
function renderToday(){
      const list = scopedPlants();
      const t = todayISO();

      const dueToday = [];
      const watered = [];
      const soon = [];
      const later = [];

      list.forEach(p => {
        if(p.lastWatered === t){ watered.push(p); return; }
        const next = plantNext(p);
        const d = next ? daysBetween(t, next) : 0;
        if(d <= 0) dueToday.push(p);
        else if(d <= 3) soon.push(p);
        else later.push(p);
      });

      dueToday.sort((a,b)=> urgency(a)-urgency(b));
      soon.sort((a,b)=> urgency(a)-urgency(b));
      later.sort((a,b)=> urgency(a)-urgency(b));
      watered.sort((a,b)=> (b.lastWatered||'').localeCompare(a.lastWatered||''));

      // counts
      todayNeedCount.textContent = String(dueToday.length);
      todayWateredCount.textContent = String(watered.length);
      todaySoonCount.textContent = String(soon.length);
      todayLaterCount.textContent = String(later.length);

      // lists
      todayNeed.innerHTML = '';
      todayWatered.innerHTML = '';
      todaySoon.innerHTML = '';
      todayLater.innerHTML = '';

      if(dueToday.length===0) todayNeed.appendChild(emptyHint('Inget som ska vattnas idag.'));
      else dueToday.forEach(p=>{ try{ todayNeed.appendChild(plantCard(p)); }catch(e){ dbg("Kunde inte rendera v√§xtkort i \"Ska vattnas idag\" ("+(p?.name||p?.nick||"ok√§nd")+")", e); } });

      if(watered.length===0) todayWatered.appendChild(emptyHint('Inget vattnat idag.'));
      else watered.forEach(p=>{ try{ todayWatered.appendChild(plantCard(p)); }catch(e){ dbg("Kunde inte rendera v√§xtkort i \"Vattnad idag\" ("+(p?.name||p?.nick||"ok√§nd")+")", e); } });

      if(soon.length===0) todaySoon.appendChild(emptyHint('Inget som ska vattnas inom 1‚Äì3 dagar.'));
      else soon.forEach(p=>{ try{ todaySoon.appendChild(plantCard(p)); }catch(e){ dbg("Kunde inte rendera v√§xtkort i \"Inom 1‚Äì3 dagar\" ("+(p?.name||p?.nick||"ok√§nd")+")", e); } });

      if(later.length===0) todayLater.appendChild(emptyHint('Inget som ska vattnas senare.'));
      else later.forEach(p=>{ try{ todayLater.appendChild(plantCard(p)); }catch(e){ dbg("Kunde inte rendera v√§xtkort i \"Ska vattnas senare\" ("+(p?.name||p?.nick||"ok√§nd")+")", e); } });

      // Standard: alla listor √§r st√§ngda n√§r appen √∂ppnas.
// Efter att anv√§ndaren √∂ppnat en lista en g√•ng (todayOpenTouched) minns vi valet.
      let openKey = (state.todayOpenTouched ? (state.todayOpen || null) : null);

      const dNeed = document.getElementById('todayNeedCard');
      const dWatered = document.getElementById('todayWateredCard');
      const dSoon = document.getElementById('todaySoonCard');
      const dLater = document.getElementById('todayLaterCard');

      if(dNeed) dNeed.open = false;
      if(dWatered) dWatered.open = false;
      if(dSoon) dSoon.open = false;
      if(dLater) dLater.open = false;
// Accordion-beteende + "manuellt styrt" n√§r anv√§ndaren √∂ppnar en lista
      [dNeed,dWatered,dSoon,dLater].forEach((d)=>{
        if(!d) return;
        if(d._alviBound) return;
        d._alviBound = true;
        d.addEventListener('toggle', ()=>{
          if(!d.open) return;
          state.todayOpenTouched = true;
          state.todayOpen = (d===dNeed)?'need':(d===dWatered)?'watered':(d===dSoon)?'soon':'later';
          if(dNeed && dNeed!==d) dNeed.open = false;
          if(dWatered && dWatered!==d) dWatered.open = false;
          if(dSoon && dSoon!==d) dSoon.open = false;
          if(dLater && dLater!==d) dLater.open = false;
        });
      });


    }

function renderFavoritesCountsOnly(){
      const favs = visiblePlants().filter(p => p.favorite);
      const need = favs.filter(p => {
        const next = plantNext(p);
        if(!next) return true;
        return daysBetween(todayISO(), next) <= 0;
      });
      const soon = favs.filter(p => {
        const next = plantNext(p);
        if(!next) return false;
        const d = daysBetween(todayISO(), next);
        return d > 0 && d <= 2;
      });
      favNeedCount.textContent = need.length;
      favSoonCount.textContent = soon.length;
    }

    // ========== ALL ==========
    const sortAll = document.getElementById("sortAll");
    const showAll = document.getElementById("showAll");
    const searchAll = document.getElementById("searchAll");
    const allList = document.getElementById("allList");
    const allSummary = document.getElementById("allSummary");

    // ALL-sektionen kan vara borttagen i mobilvyn. S√§kerst√§ll att sidan inte kraschar.
    if (sortAll && showAll && searchAll && allList) {
      sortAll.addEventListener("change", renderAll);
      showAll.addEventListener("change", renderAll);
      searchAll.addEventListener("input", renderAll);
    }

    const copyTodayBtn = document.getElementById("copyToday");
    if(copyTodayBtn){
      copyTodayBtn.addEventListener("click", async () => {
        const list = visiblePlants().slice().sort((a,b)=> urgency(a)-urgency(b));
        const lines = list.map(p => {
          const home = getHome(p.homeId)?.name || "‚Äî";
          const st = statusLabel(p);
          return `${p.name} (${home} ‚Ä¢ ${p.room || "‚Äî"}) ‚Äî ${st.text} ‚Äî ${st.extra}`;
        });
        const txt = `ALVIS V√§xtkoll ‚Äì Dagens lista (${todayISO()})\n\n` + lines.join("\n");

        // F√∂rs√∂k kopiera via Clipboard API. P√• content:// kan det nekas.
        try{
          if(navigator.clipboard && navigator.clipboard.writeText){
            await navigator.clipboard.writeText(txt);
            alert("Kopierat!");
            return;
          }
        }catch(e){
          dbg("Kunde inte kopiera till urklipp.", e);
        }

        // Fallback: visa texten s√• anv√§ndaren kan markera/kopiera manuellt.
        prompt("Kopiera texten manuellt:", txt);
      });
    }

    function renderAll(){
    if(!allList || !sortAll || !showAll || !searchAll) return;
      const scopeList = scopedPlants(); // ej arkiv + hem/rum-filter
      let list = scopeList.slice();

      const mode = showAll.value;
      if(mode === "favorite") list = list.filter(p => p.favorite);
      if(mode === "need") list = list.filter(p => {
        const next = plantNext(p);
        if(!next) return true;
        return daysBetween(todayISO(), next) <= 0;
      });
      if(mode === "soon") list = list.filter(p => {
        const next = plantNext(p);
        if(!next) return false;
        const d = daysBetween(todayISO(), next);
        return d > 0 && d <= 2;
      });

      // S√∂k
      list = list.filter(p => plantMatchesSearch(p, searchAll.value.trim()));

      // Sort
      const s = sortAll.value;
      if(s === "urgent") list.sort((a,b)=> urgency(a)-urgency(b));
      if(s === "name") list.sort((a,b)=> (a.name||"").localeCompare(b.name||"", "sv"));
      if(s === "room") list.sort((a,b)=> (a.room||"").localeCompare(b.room||"", "sv"));
      if(s === "home") list.sort((a,b)=> (getHome(a.homeId)?.name||"").localeCompare(getHome(b.homeId)?.name||"", "sv"));
      if(s === "last") list.sort(byLastWatered);

      // Summering (samma scope som snabbvyn)
      const total = scopeList.length;
      const need = scopeList.filter(p => {
        const next = plantNext(p);
        if(!next) return true;
        return daysBetween(todayISO(), next) <= 0;
      }).length;
      const soon = scopeList.filter(p => {
        const next = plantNext(p);
        if(!next) return false;
        const d = daysBetween(todayISO(), next);
        return d > 0 && d <= 2;
      }).length;

      allSummary.textContent = `V√§xter: ${total} ‚Ä¢ Beh√∂ver idag: ${need} ‚Ä¢ Snart: ${soon}`;

      allList.innerHTML = "";
      if(list.length === 0){
        allList.appendChild(emptyHint("Inga v√§xter matchar filtret."));
        return;
      }
      list.forEach(p => allList.appendChild(plantCard(p)));
    }
    // ========== ADD ==========
    const pName = document.getElementById("pName");
    const pHome = document.getElementById("pHome");
    const pRoom = document.getElementById("pRoom");
    const pPlace = document.getElementById("pPlace");
    const pWindow = document.getElementById("pWindow");
    const pInterval = document.getElementById("pInterval");
    const pLast = document.getElementById("pLast");
    const pPrice = document.getElementById("pPrice");
    const pStore = document.getElementById("pStore");
    const pBuy = document.getElementById("pBuy");
    const pNotes = document.getElementById("pNotes");
    const pPhoto = document.getElementById("pPhoto");
    const pPhotoClear = document.getElementById("pPhotoClear");
    const pPhotoPreview = document.getElementById("pPhotoPreview");

    let addPhotoDataUrls = [];

    function refreshAddFormSelects(){
      try{
        fillHomes(pHome);
        if(!pHome.value) pHome.value = state.homes[0]?.id;
        fillRooms(pRoom, pHome.value);
        if(!pRoom.value) pRoom.value = getHome(pHome.value).rooms?.[0] || "Annan";
      }catch(e){
        dbg("Kunde inte fylla rullistorna Hem/Rum i L√§gg till.", e);
      }
    }

    pHome.addEventListener("change", () => {
      fillRooms(pRoom, pHome.value);
    });

    pPhotoPreview.style.cursor = "pointer";
    pPhotoPreview.title = "Tryck f√∂r att v√§lja foto";
    pPhotoPreview.addEventListener("click", () => pPhoto.click());

    pPhoto.addEventListener("change", async () => {
      const files = Array.from(pPhoto.files || []);
      if(!files.length) return;
      // append: l√•t anv√§ndaren v√§lja 1, sen v√§lja igen f√∂r att fylla p√• (upp till 4)
      for(const f of files){
        if((addPhotoDataUrls || []).length >= 4) break;
        try{
          const u = await fileToDataUrl(f);
          if(!addPhotoDataUrls.includes(u)) addPhotoDataUrls.push(u);
        }catch(e){}
      }
      // begr√§nsa
      addPhotoDataUrls = (addPhotoDataUrls || []).slice(0,4);
      renderAddPhotoPreview();
      // rensa input s√• samma fil kan v√§ljas igen om man vill
      try{ pPhoto.value = ""; }catch(e){}
    });
    pPhotoClear.addEventListener("click", () => {
      pPhoto.value = "";
      addPhotoDataUrls = [];
      renderAddPhotoPreview();
    });

    function renderAddPhotoPreview(){
      pPhotoPreview.innerHTML = "";
      const urls = (addPhotoDataUrls || []).slice(0,4);
      if(urls.length){
        const grid = document.createElement("div");
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = urls.length > 1 ? "repeat(2, 1fr)" : "1fr";
        grid.style.gap = "6px";
        grid.style.width = "100%";
        grid.style.height = "100%";
        for(const u of urls){
          const wrap = document.createElement("div");
          wrap.style.width = "100%";
          wrap.style.height = "100%";
          wrap.style.borderRadius = "12px";
          wrap.style.overflow = "hidden";
          const img = document.createElement("img");
          img.src = u;
          img.alt = "Foto";
          img.style.width = "100%";
          img.style.height = "100%";
          img.style.objectFit = "cover";
          wrap.appendChild(img);
          grid.appendChild(wrap);
        }
        pPhotoPreview.appendChild(grid);
      }else{
        const no = document.createElement("div");
        no.className = "noimg";
        no.textContent = "Inget foto";
        pPhotoPreview.appendChild(no);
      }
    }
    renderAddPhotoPreview();

    let _photoPickForPlantId = null;
    let _timelinePickForPlantId = null;
    const timelinePhotoPicker = document.getElementById("timelinePhotoPicker");

    function openTimelinePickerFor(plantId){
      _timelinePickForPlantId = plantId;
      if(timelinePhotoPicker){
        timelinePhotoPicker.value = "";
        timelinePhotoPicker.click();
      }
    }

    if(timelinePhotoPicker){
      timelinePhotoPicker.addEventListener("change", async () => {
        const file = timelinePhotoPicker.files?.[0];
        if(!file || !_timelinePickForPlantId) return;
        try{
          const dataUrl = await fileToDataUrl(file);
          const p = state.plants.find(x => x.id === _timelinePickForPlantId);
          if(p){
            const note = prompt("Skriv en kort notering:", "") ?? "";
            p.gallery ||= [];
            p.gallery.unshift({
              id: uid(),
              date: todayISO(),
              photo: dataUrl,
              note: (note || "").trim()
            });
            // Om v√§xten saknar omslagsfoto: anv√§nd f√∂rsta minnet som omslag
            if(!p.photo) p.photo = dataUrl;

            p.openedAt = Date.now();
            saveState();
            renderPlants?.(); // om funktionen finns
            renderFavorites?.();
            renderToday?.();
            renderAll?.();
            renderMore?.();
          }
        }finally{
          _timelinePickForPlantId = null;
          timelinePhotoPicker.value = "";
        }
      });
    }

    
    // ===== Modal-l√§ge: minnen vs v√§xtfoton =====
    let _modalMode = "gallery"; // "gallery" | "plantPhotos"
    let _modalPhotos = [];      // anv√§nds n√§r _modalMode === "plantPhotos"

    function openPlantPhotosModal(plantId, index=0){
      const p = state.plants.find(x => x.id === plantId);
      if(!p) return;
      ensurePhotos(p);
      const photos = (p.photos || []).slice(0,4).filter(Boolean);
      if(!photos.length) return;

      _modalMode = "plantPhotos";
      _modalPlantId = plantId;
      _modalPhotos = photos;
      _modalIndex = Math.max(0, Math.min(index, photos.length-1));
      renderGalleryModal();

      // <dialog> fallback
      if(photoModal?.showModal) photoModal.showModal();
      else {
        photoModal?.setAttribute("open","open");
        // s√§kerst√§ll synlighet om dialog saknar native support
        photoModal.style.display = "block";
      }
    }

// Modal f√∂r att bl√§ddra i minnen
    const photoModal = document.getElementById("photoModal");
    const photoModalImg = document.getElementById("photoModalImg");
    const photoModalMeta = document.getElementById("photoModalMeta");
    const photoModalTitle = document.getElementById("photoModalTitle");
    const photoModalClose = document.getElementById("photoModalClose");
    const photoModalPrev = document.getElementById("photoModalPrev");
    const photoModalNext = document.getElementById("photoModalNext");

    const photoModalChange = document.getElementById("photoModalChange");
    let _photoReplaceIndex = null;
    let _photoPickReplaceOne = false;

    // Klick utanf√∂r dialog-inneh√•llet st√§nger (backdrop)
    if(photoModal){
      photoModal.addEventListener("click", (e) => {
        if(e.target === photoModal) closeGalleryModal();
      });
    }


    let _modalPlantId = null;
    let _modalIndex = 0;

    function openGalleryModal(plantId, index){
      const p = state.plants.find(x => x.id === plantId);
      if(!p || !p.gallery?.length) return;
      _modalPlantId = plantId;
      _modalIndex = Math.max(0, Math.min(index, p.gallery.length-1));
      renderGalleryModal();
      if(photoModal?.showModal) photoModal.showModal();
      else photoModal?.setAttribute("open","open");
    }

    function closeGalleryModal(){
      _modalMode = "gallery";
      _modalPhotos = [];
      if(photoModal?.close) photoModal.close();
      else photoModal?.removeAttribute("open");
    }

    function renderGalleryModal(){
      const p = state.plants.find(x => x.id === _modalPlantId);
      if(!p) return;

      if(_modalMode === "plantPhotos"){
        // V√§xtens egna foton (photos)
        const photos = (_modalPhotos || []).slice(0,4).filter(Boolean);
        const url = photos[_modalIndex];
        photoModalTitle.textContent = p.name || "Foto";
        photoModalImg.src = url;
        photoModalMeta.innerHTML = `<span style="opacity:.85">Bild</span> <b>${_modalIndex+1}</b><span style="opacity:.85">/${photos.length}</span>`;

        photoModalPrev.disabled = (_modalIndex <= 0);
        photoModalNext.disabled = (_modalIndex >= photos.length-1);
        if(photoModalChange) photoModalChange.style.display = "inline-flex";
        return;
      }

      // Minnen / galleri
      const item = p.gallery[_modalIndex];
      if(!item) return;

      photoModalTitle.textContent = p.name || "Foto";
      photoModalImg.src = item.photo;
      const note = item.note ? ` ‚Ä¢ ${escapeHtml(item.note)}` : "";
      photoModalMeta.innerHTML = `üìÖ ${escapeHtml(item.date || "‚Äî")} <span style="opacity:.8">${note}</span> <span style="float:right;opacity:.7">${_modalIndex+1}/${p.gallery.length}</span>`;

      photoModalPrev.disabled = (_modalIndex <= 0);
      photoModalNext.disabled = (_modalIndex >= p.gallery.length-1);
      if(photoModalChange) photoModalChange.style.display = "none";
    }

    photoModalClose?.addEventListener("click", closeGalleryModal);
    photoModal?.addEventListener("click", (e) => {
      // klick p√• bakgrund st√§nger
      const rect = photoModal.getBoundingClientRect();
      const inDialog = (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom);
      // dialog element click always inside; use target check
    });
    photoModalPrev?.addEventListener("click", () => { _modalIndex = Math.max(0,_modalIndex-1); renderGalleryModal(); });
    photoModalNext?.addEventListener("click", () => {
      if(_modalMode === "plantPhotos"){
        const max = (_modalPhotos || []).filter(Boolean).length - 1;
        _modalIndex = Math.min(max, _modalIndex+1);
        renderGalleryModal();
        return;
      }
      const p = state.plants.find(x => x.id === _modalPlantId);
      if(!p) return;
      _modalIndex = Math.min(p.gallery.length-1, _modalIndex+1);
      renderGalleryModal();
    });


    photoModalChange?.addEventListener("click", () => {
      if(_modalMode !== "plantPhotos") return;
      const ok = confirm("√Ñr du s√§ker p√• att du vill √§ndra denna bild? Den nuvarande bilden ers√§tts.");
      if(!ok) return;
      _photoReplaceIndex = _modalIndex;
      openPhotoPickerFor(_modalPlantId, true);
    });

const globalPhotoPicker = document.getElementById("globalPhotoPicker");

    function openPhotoPickerFor(plantId, replaceOne=false){
      _photoPickForPlantId = plantId;
      _photoPickReplaceOne = !!replaceOne;
      if(globalPhotoPicker){
        globalPhotoPicker.value = "";
        globalPhotoPicker.click();
      }
    }

    if(globalPhotoPicker){
      globalPhotoPicker.addEventListener("change", async () => {
        const filesAll = Array.from(globalPhotoPicker.files || []);
        if(!filesAll.length || !_photoPickForPlantId) return;
        try{
          const p = state.plants.find(x => x.id === _photoPickForPlantId);
          if(p){
            ensurePhotos(p);

            if(_photoPickReplaceOne){
              const f = filesAll[0];
              const dataUrl = await fileToDataUrl(f);
              const idx = (typeof _photoReplaceIndex === "number") ? _photoReplaceIndex : (p.photoIndex||0);

              while(p.photos.length < 4) p.photos.push(null);
              p.photos[idx] = dataUrl;
              while(p.photos.length && !p.photos[p.photos.length-1]) p.photos.pop();
              p.photos = p.photos.slice(0,4);

              p.photoIndex = Math.max(0, Math.min(p.photos.length-1, idx));
              p.photo = p.photos[p.photoIndex] || p.photos[0] || null;

              p.openedAt = Date.now();
              saveState();
              renderToday(); renderAll(); renderMore();

              // uppdatera modalen om den √§r √∂ppen
              try{
                if(_modalMode === "plantPhotos" && photoModal?.open){
                  _modalPhotos = (p.photos||[]).slice(0,4).filter(Boolean);
                  _modalIndex = Math.max(0, Math.min(_modalPhotos.length-1, p.photoIndex||0));
                  renderGalleryModal();
                }
              }catch(e){}
              return;
            }

            // L√§gg till (merge) upp till 4
            const files = filesAll.slice(0,4);
            for(const f of files){
              try{
                const dataUrl = await fileToDataUrl(f);
                if(!p.photos.includes(dataUrl)) p.photos.push(dataUrl);
              }catch(e){}
            }
            p.photos = p.photos.slice(0,4);

            if(!p.photos.length){
              p.photo = null;
              p.photoIndex = 0;
            }else{
              if(!p.photo) { p.photoIndex = 0; p.photo = p.photos[0]; }
              if(p.photo && !p.photos.includes(p.photo)){
                p.photos.unshift(p.photo);
                p.photos = p.photos.slice(0,4);
                p.photoIndex = 0;
              }else{
                p.photoIndex = Math.max(0, p.photos.indexOf(p.photo));
              }
              p.photo = p.photos[p.photoIndex] || p.photos[0] || null;
            }

            p.openedAt = Date.now();
            saveState();
            renderToday(); renderAll(); renderMore();
          }
        }finally{
          _photoPickForPlantId = null;
          _photoPickReplaceOne = false;
          _photoReplaceIndex = null;
          globalPhotoPicker.value = "";
        }
      });}

    async function fileToDataUrl(file){
      // Komprimera bilder s√• localStorage inte spr√§ngs (Android/WebView har ofta ~5MB-gr√§ns)
      const readAsDataUrl = (f) => new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(f);
      });

      // Om det inte √§r en bild: fallback
      if(!file || !String(file.type||"").startsWith("image/")){
        return await readAsDataUrl(file);
      }

      // L√§s in, rita om till canvas och exportera som JPEG
      const dataUrl = await readAsDataUrl(file);
      const img = await new Promise((res, rej) => {
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.src = dataUrl;
      });

      const maxSide = 720;
      let w = img.naturalWidth || img.width;
      let h = img.naturalHeight || img.height;
      if(!w || !h) return dataUrl;

      const scale = Math.min(1, maxSide / Math.max(w, h));
      const cw = Math.max(1, Math.round(w * scale));
      const ch = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement("canvas");
      canvas.width = cw;
      canvas.height = ch;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, cw, ch);

      // JPEG ger mycket mindre storlek √§n PNG/dataURL fr√•n mobilen
      try{
        return canvas.toDataURL("image/jpeg", 0.78);
      }catch(e){
        // fallback om toDataURL misslyckas
        return dataUrl;
      }
    }


    document.getElementById("fillExample").addEventListener("click", () => {
      pName.value = "Fredskalla";
      pPlace.value = "F√∂nsterbr√§dan";
      pWindow.value = "√ñsterl√§ge";
      pInterval.value = 7;
      pLast.value = addDays(todayISO(), -6);
      pPrice.value = 199;
      pStore.value = "Blomsterlandet";
      pBuy.value = addDays(todayISO(), -12);
      pNotes.value = "Vattna ordentligt tills det rinner igenom. H√§ll bort √∂verfl√∂d i ytterkrukan efter 10 min. Spreja/mista bladen l√§tt.";
    });

    document.getElementById("savePlant").addEventListener("click", () => {
      const name = pName.value.trim();
      if(!name){
        alert("Skriv ett v√§xtnamn f√∂rst.");
        return;
      }
      const homeIdRaw = pHome.value;
      const safeHomeId = homeIdRaw || state.homes[0]?.id || "home-1";
      const room = pRoom.value || "Annan";
      const interval = Math.max(1, Number(pInterval.value || 7));

      const plant = {
        id: uid(),
        name,
        homeId: safeHomeId,
        room,
        place: pPlace.value.trim(),
        window: pWindow.value || "",
        intervalDays: interval,
        lastWatered: pLast.value || null,
        price: pPrice.value === "" ? null : Number(pPrice.value),
        store: pStore.value.trim(),
        buyDate: pBuy.value || "",
        notes: pNotes.value.trim(),
        favorite:false,
        archived:false,
        photo: (addPhotoDataUrls?.[0] || null),
        photos: (addPhotoDataUrls || []).slice(0,4),
        photoIndex: 0,
        openedAt: Date.now()
      };

      state.plants.unshift(plant);
      saveState();

      pName.value = "";
      pPlace.value = "";
      pWindow.value = "";
      pInterval.value = 7;
      pLast.value = "";
      pPrice.value = "";
      pStore.value = "";
      pBuy.value = "";
      pNotes.value = "";
      pPhoto.value = "";
      addPhotoDataUrls = [];
      renderAddPhotoPreview();
      refreshAddFormSelects();

      alert("Sparat!");
      // g√• tillbaka och uppdatera listor
      renderToday(); renderAll(); renderMore();
      setTab("plants");
      // St√§ng "Mer" om den var √∂ppnad
      const moreDetails = document.querySelector("#sec-add details");
      if(moreDetails) moreDetails.open = false;
    });

    refreshAddFormSelects();

    // ========== EDIT (enkel prompt-baserad) ==========
    function openEdit(plantId){
      const p = state.plants.find(x => x.id === plantId);
      if(!p) return;

      const name = prompt("V√§xtnamn:", p.name ?? "");
      if(name === null) return;
      p.name = name.trim() || p.name;

      const interval = prompt("Vattna var (dagar):", String(p.intervalDays ?? 7));
      if(interval !== null){
        const n = Math.max(1, Number(interval || p.intervalDays || 7));
        p.intervalDays = n;
      }

      const last = prompt("Senast vattnad (YYYY-MM-DD eller tomt):", p.lastWatered ?? "");
      if(last !== null){
        const v = last.trim();
        p.lastWatered = v ? v : null;
      }

      const notes = prompt("Notering / instruktion:", p.notes ?? "");
      if(notes !== null) p.notes = notes.trim();

      saveState();
      renderToday(); renderAll(); renderMore();
    }

    // ========== MORE ==========
    const makePdfBtn = document.getElementById("makePdf");
    const pdfHome = document.getElementById("pdfHome");

    // OBS: renderMore kan anropas tidigt (innan resten av scriptet har k√∂rt klart),
    // s√• vi h√§mtar DOM-elementen inuti funktionen f√∂r att undvika TDZ/initialiseringsfel.
    function renderMore(){

      if(pdfHome){
        fillHomes(pdfHome);
      }
    }

    if(makePdfBtn){
      makePdfBtn.addEventListener("click", async () => {

        const homeId = (pdfHome?.value) || state.homes[0]?.id;
        const home = getHome(homeId);
        const plants = visiblePlants().filter(p => p.homeId === homeId);

      if(!plants.length){
        alert("Inga v√§xter i valt hem.");
        return;
      }
      if(!window.jspdf || !window.jspdf.jsPDF){
        alert("PDF-biblioteket kunde inte laddas. Kontrollera internetanslutning (CDN) och f√∂rs√∂k igen.");
        return;
      }
      if(!window.html2canvas){
        alert("html2canvas kunde inte laddas. Kontrollera internetanslutning (CDN) och f√∂rs√∂k igen.");
        return;
      }

      // Bygg en snygg PDF-vy som ser ut som korten i appen
      const render = document.createElement("div");
      render.id = "pdfRenderRoot";
      render.style.position = "fixed";
      render.style.left = "-10000px";
      render.style.top = "0";
      render.style.width = "794px";   // ~A4 vid 96dpi
      render.style.padding = "18px";
      render.style.background = state.settings.dark ? "#0f172a" : "#ffffff";
      render.style.color = state.settings.dark ? "#e5e7eb" : "#0f172a";
      render.style.fontFamily = "var(--font)";

      // Rubrik
      const header = document.createElement("div");
      header.className = "card";
      header.style.boxShadow = "none";
      header.style.marginBottom = "14px";
      header.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
          <div>
            <div style="font-weight:900;font-size:20px;">ALVIS V√§xtkoll ‚Äì ${escapeHtml(home?.name || "Hem")}</div>
            <div class="subtle" style="margin-top:4px;">Skapad: ${todayISO()}</div>
          </div>
          <div class="pill ok" style="align-self:flex-start;">
            <span>üìÑ</span> Vattningslista
          </div>
        </div>
      `;
      render.appendChild(header);

      // Grupp per rum
      const byRoom = {};
      for(const p of plants){
        const r = p.room || "Annan";
        byRoom[r] ||= [];
        byRoom[r].push(p);
      }
      Object.values(byRoom).forEach(arr => arr.sort((a,b)=> urgency(a)-urgency(b)));
      const roomNames = Object.keys(byRoom).sort((a,b)=> a.localeCompare(b,"sv"));

      for(const room of roomNames){
        const sec = document.createElement("div");
        sec.className = "card";
        sec.style.boxShadow = "none";
        sec.style.marginBottom = "14px";
        sec.innerHTML = `<div style="font-weight:900;font-size:16px;margin-bottom:10px;">Rum: ${escapeHtml(room)}</div>`;
        const listWrap = document.createElement("div");
        for(const p of byRoom[room]){
          listWrap.appendChild(plantPdfCard(p, home));
        }
        sec.appendChild(listWrap);
        render.appendChild(sec);
      }

      document.body.appendChild(render);

      // L√•t layouten s√§tta sig
      await new Promise(r => requestAnimationFrame(() => r()));

      // Rendera till canvas (h√∂gre scale = skarpare men st√∂rre fil)
      const canvas = await html2canvas(render, {
        scale: 2,
        backgroundColor: state.settings.dark ? "#0f172a" : "#ffffff",
        useCORS: true
      });

      // Skapa PDF och dela upp canvasen p√• A4-sidor
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:"pt", format:"a4"});

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      // Marginaler (s√• inget hamnar f√∂r n√§ra kanten i PDF-l√§sare)
      const M = 28; // pt (~10 mm). Justera vid behov.
      const contentW = pageW - M*2;
      const contentH = pageH - M*2;

      const imgW = contentW;
      const ratio = imgW / canvas.width;
      const sliceHpx = contentH / ratio;

      // ==== Undvik att v√§xter kapas mitt i (sidbrytning p√• kort-gr√§nser) ====
      // Vi snappar sidbrytningen till n√§rmaste "top" f√∂r ett v√§xtkort i render-roten.
      const scale = 2; // matchar html2canvas scale ovan
      const plantsEls = Array.from(render.querySelectorAll(".plant"));
      const rootRect = render.getBoundingClientRect();
      const breakpoints = plantsEls
        .map(el => Math.round((el.getBoundingClientRect().top - rootRect.top) * scale))
        .filter(v => v > 0)
        .sort((a,b)=>a-b);

      // s√§kerst√§ll att vi aldrig v√§ljer en brytpunkt f√∂r n√§ra kanten (minsta marginal)
      const MIN_SLICE_PX = Math.round(220 * scale); // ca 220px i DOM
      const MIN_TAIL_PX  = Math.round(140 * scale); // l√§mna lite luft l√§ngst ner

      let y = 0;
      let pageIndex = 0;

      while(y < canvas.height){
        // f√∂reslagen sid-slutpunkt om vi bara skulle kapa vid A4-h√∂jden (minus marginal)
        let endY = Math.min(canvas.height, Math.round(y + sliceHpx));

        // hitta b√§sta brytpunkt: sista breakpoint som ligger inom sidan
        // men inte f√∂r n√§ra start/slut.
        const candidates = breakpoints.filter(bp => (bp > y + MIN_SLICE_PX) && (bp < endY - MIN_TAIL_PX));
        if(candidates.length){
          endY = candidates[candidates.length - 1];
        }

        const sliceCanvas = document.createElement("canvas");
        sliceCanvas.width = canvas.width;
        sliceCanvas.height = Math.max(1, endY - y);

        const ctx = sliceCanvas.getContext("2d");
        ctx.drawImage(canvas, 0, y, canvas.width, endY - y, 0, 0, canvas.width, endY - y);

        const imgData = sliceCanvas.toDataURL("image/jpeg", 0.92);

        if(pageIndex > 0) doc.addPage();
        // L√§gg in med marginaler
        doc.addImage(imgData, "JPEG", M, M, imgW, (endY - y) * ratio);

        y = endY;
        pageIndex++;
      }render.remove();

      doc.save(`ALVIS_Vaxtkoll_${(home?.name||"Hem").replace(/\s+/g,"_")}_${todayISO()}.pdf`);
    });
    }

    // Export/import
    document.getElementById("exportAll").addEventListener("click", () => {
      const payload = {
        app:"ALVIS V√§xtkoll",
        type:"all",
        exportedAt: new Date().toISOString(),
        data: state
      };
      downloadJson(payload, `ALVIS_Vaxtkoll_all_${todayISO()}.json`);
    });

    document.getElementById("exportHome").addEventListener("click", () => {
      const homeId = (pdfHome?.value) || state.homes[0]?.id;
      const home = getHome(homeId);
      const plants = state.plants.filter(p => p.homeId === homeId);
      const payload = {
        app:"ALVIS V√§xtkoll",
        type:"home",
        exportedAt: new Date().toISOString(),
        data: { homes: [home], plants }
      };
      downloadJson(payload, `ALVIS_Vaxtkoll_${(home?.name||"Hem").replace(/\s+/g,"_")}_${todayISO()}.json`);
    });
document.getElementById("importHomeFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const obj = JSON.parse(await file.text());
        const pack = obj.data;
        if(!pack || !pack.homes || !pack.plants) throw new Error("Fel format.");

        for(const h of pack.homes){
          if(!state.homes.find(x => x.id === h.id)){
            state.homes.push(h);
          }else{
            const cur = state.homes.find(x => x.id === h.id);
            const rooms = new Set([...(cur.rooms||[]), ...(h.rooms||[])]);
            cur.rooms = Array.from(rooms);
          }
        }
        for(const p of pack.plants){
          if(!state.plants.find(x => x.id === p.id)){
            state.plants.push(p);
          }
        }

        saveState();
        renderToday(); renderAll(); renderMore();
        alert("Importerat hem!");
      }catch(err){
        alert("Kunde inte importera. Kontrollera att filen √§r en ALVIS V√§xtkoll-export.");
      }finally{
        e.target.value = "";
      }
    });

    document.getElementById("importPlantFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const obj = JSON.parse(await file.text());
        const plant = obj.data?.plant || obj.plant || obj.data;
        if(!plant || !plant.id) throw new Error("Fel format.");

        if(!state.homes.find(h => h.id === plant.homeId)){
          state.homes.push({ id: plant.homeId, name:"Importerat hem", rooms: ["Annan", "Utomhus"] });
        }
        const home = getHome(plant.homeId);
        if(plant.room && !(home.rooms||[]).includes(plant.room)){
          home.rooms.push(plant.room);
        }

        const idx = state.plants.findIndex(p => p.id === plant.id);
        if(idx >= 0) state.plants[idx] = plant;
        else state.plants.push(plant);

        saveState();
        renderToday(); renderAll(); renderMore();
        alert("Importerat v√§xt!");
      }catch(err){
        alert("Kunde inte importera v√§xt. Kontrollera filformatet.");
      }finally{
        e.target.value = "";
      }
    });

    function downloadJson(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById("showArchive").addEventListener("click", () => {
      const el = document.getElementById("archiveList");
      const show = el.style.display === "none";
      renderArchive(show);
    });

    function renderArchive(show){
      const el = document.getElementById("archiveList");
      el.style.display = show ? "block" : "none";
      if(!show) return;

      const archived = state.plants.filter(p => p.archived).slice().sort((a,b)=> (b.openedAt||0)-(a.openedAt||0));
      el.innerHTML = "";
      if(archived.length === 0){
        el.appendChild(emptyHint("Arkivet √§r tomt."));
        return;
      }
      for(const p of archived){
        const card = plantCard(p);
        const btnRow = card.querySelector("details.more .btnRow");
        if(btnRow){
          btnRow.innerHTML = "";

          const restore = document.createElement("button");
          restore.className = "btn primary";
          restore.textContent = "√Öterst√§ll";
          restore.addEventListener("click", () => {
            p.archived = false;
            saveState();
            renderArchive(true);
            renderToday(); renderAll();
          });

          const del = document.createElement("button");
          del.className = "btn danger";
          del.textContent = "Ta bort";
          del.addEventListener("click", () => {
            if(confirm("Ta bort v√§xten permanent?")){
              state.plants = state.plants.filter(x => x.id !== p.id);
              saveState();
              renderArchive(true);
              renderToday(); renderAll();
            }
          });

          btnRow.appendChild(restore);
          btnRow.appendChild(del);
        }
        el.appendChild(card);
      }
    }

    // ========== Init render ==========
    renderPlants();
    renderMore();

// ===== Tvinga dropdowns st√§ngda som standard =====
function closeAllDropdowns(){
  document.querySelectorAll("details").forEach(d => {
    d.removeAttribute("open");
  });
}

// Vid f√∂rsta laddning
document.addEventListener("DOMContentLoaded", () => {
  closeAllDropdowns();
});

// Om appen renderar om inneh√•ll dynamiskt
const _origRender = window.renderPlants;
if(typeof _origRender === "function"){
  window.renderPlants = function(){
    _origRender.apply(this, arguments);
    closeAllDropdowns();
  };
}

</script>

<div class="appInfoFooter">
  <p>
    ALVIS V√§xtkoll √§r en lokal app. All information och alla bilder du l√§gger in
    sparas endast p√• din egen telefon.
  </p>
  <p>
    Om du byter telefon, rensar webbl√§sardata eller tar bort appen kan
    informationen f√∂rsvinna.
  </p>
  <p>
    Tips: Exportera och spara PDF eller exportfiler regelbundet (t.ex. i OneDrive
    eller annan molntj√§nst) f√∂r att ha en s√§kerhetskopia.
  </p>
</div>


<div style="margin-top:40px; padding:16px; font-size:12px; opacity:0.8; text-align:center;">
  <strong>Om appen</strong><br>
  All data sparas endast lokalt p√• din telefon.<br>
  Byter du telefon eller rensar data kan informationen f√∂rsvinna.<br>
  Exportera och spara filer regelbundet f√∂r s√§kerhetskopia.
</div>


<script>
  // PWA: registrera service worker (kr√§ver https, t.ex. GitHub Pages)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
</script>

</body>
</html>
